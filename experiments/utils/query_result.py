"""
Enhanced query result model with detailed instrumentation fields.

This module defines the extended QueryResult and DataFrame conversion used
by the workload executor. The original ssb_workload.py QueryResult is left
untouched for backward compatibility â€” the executor uses this version instead.
"""

from dataclasses import dataclass, field
from typing import Optional

import pandas as pd


@dataclass
class QueryResult:
    """
    Result of a single query execution with full instrumentation.

    Core fields (same as original):
        name            - Query identifier (e.g. "q_1_1")
        start           - Unix timestamp when run_query began (after pool scheduling)
        end             - Unix timestamp when query result was received
        elapsed         - Wall-clock duration in seconds (end - start)
        success         - Whether the query completed successfully
        mode            - Execution context string (e.g. "phases/ramp_up")
        scale_factor    - SSB scale factor
        iteration       - Iteration number (1-indexed)
        workers         - Worker count on the ComputeUnit
        error           - Error message if failed, else None

    New instrumentation fields:
        workload_name       - Name of the YAML workload config that produced this result
        query_flight        - Query complexity tier (1-4), derived from query name
        phase_name          - Phase name (for phases pattern), or None
        user_id             - Virtual user ID (for virtual_users pattern), or None
        sequence_number     - Global dispatch order within the workload iteration
        concurrent_in_flight - Number of queries already in-flight when this query was dispatched
        planned_delay_s     - Inter-arrival delay generated by the arrival model for this query
        submit_timestamp    - Unix timestamp when the query was submitted to the thread pool
    """

    # --- Core fields ---
    name: str
    start: float
    end: float
    elapsed: float
    success: bool
    mode: str
    window_size: int
    max_overhead: float
    scale_factor: int
    iteration: int
    workers: int
    error: Optional[str] = None

    # --- New instrumentation fields ---
    workload_name: Optional[str] = None
    query_flight: Optional[int] = None
    phase_name: Optional[str] = None
    user_id: Optional[int] = None
    sequence_number: Optional[int] = None
    concurrent_in_flight: Optional[int] = None
    planned_delay_s: Optional[float] = None
    submit_timestamp: Optional[float] = None


def extract_query_flight(query_name: str) -> int:
    """
    Extract the flight number (1-4) from a query name like 'q_3_2'.
    Returns 0 if the name doesn't match the expected pattern.
    """
    try:
        parts = query_name.split("_")
        # Handle both "q_1_1" and "0_q_1_1" (prefixed with iteration index)
        for part in parts:
            if part.isdigit() and 1 <= int(part) <= 4:
                return int(part)
    except (ValueError, IndexError):
        pass
    return 0


def results_to_dataframe(results: list[QueryResult]) -> pd.DataFrame:
    """Convert a list of QueryResult to a pandas DataFrame with all fields."""
    return pd.DataFrame([
        {
            # Core
            "name": r.name,
            "scale_factor": r.scale_factor,
            "iteration": r.iteration,
            "start": r.start,
            "end": r.end,
            "elapsed_seconds": r.elapsed,
            "workers": r.workers,
            "success": r.success,
            "mode": r.mode,
            "error": r.error,
            "window_size": r.window_size,
            "max_overhead": r.max_overhead,
            # New instrumentation
            "workload_name": r.workload_name,
            "query_flight": r.query_flight,
            "phase_name": r.phase_name,
            "user_id": r.user_id,
            "sequence_number": r.sequence_number,
            "concurrent_in_flight": r.concurrent_in_flight,
            "planned_delay_s": r.planned_delay_s,
            "submit_timestamp": r.submit_timestamp,
        }
        for r in results
    ])